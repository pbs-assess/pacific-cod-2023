\clearpage

# Figures

```{r fig-map, fig.cap="Map of the management areas 5AB (Queen Charlotte Sound), 5CD (Hecate Strait), and 3CD (West Coast Vancouver Island).", out.width="4in"}
knitr::include_graphics(here::here("report/figure/Pcod_3CD5ABCDE_names.png"))

```

```{r fig-surv-canadian, fig.cap="Pacific Cod survey data for Canadian trawl surveys. Shown is relative biomass and associated lower and upper confidence intervals. Positive sets refers to the number of trawl sets that caught Pacific Cod. SYN WCVI = West Coast Vancouver Island synoptic bottom trawl survey; SYN QCS = Queen Charlotte Sound synoptic bottom trawl survey;  SYN HS = Hecate Strait synoptic bottom trawl survey. Indices for the QCS and HS synoptic surveys are not part of this assessment but are shown for comparison"}
gfplot::tidy_survey_index(dat$survey_index,
  survey = c("SYN WCVI", "SYN QCS", "SYN HS")) %>%
  plot_survey_index(french=french)
```

```{r fig-catch-3cd, fig.cap="Catch for Area 3CD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.3, french=french) +
  scale_y_continuous(labels = comma,
                       limits = c(0, NA))
```

```{r cpue-funcs}
source(here::here('R/cpue-functions.R'))
```

```{r cpue-params}
params <- list()
params$species_proper <- "Pacific Cod"
params$april1_year <- TRUE
params$area <- c("3[CD]+")
params$area_name <- c("3CD")
params$skip_single_variable_models <- FALSE
```

```{r cpue-run-historic, message=FALSE, warning=FALSE, results='hide'}
params$era <- "historic"
source(here::here("R/cpue.R"))
dfleet_hist <- dfleet
gg_cpue_hist <- gg_cpue
cpue_pred_hist <- predictions
arith_cpue_hist <- arith_cpue
m_historic <- readRDS(here::here("data/generated/cpue-models-pcod-historic.rds"))
```

```{r cpue-run-modern, message=FALSE, warning=FALSE, results='hide'}
params$era <- "modern"
source(here::here("R/cpue.R"))
dfleet_modern <- dfleet
gg_cpue_modern <- gg_cpue
cpue_pred_modern <- predictions
arith_cpue_modern <- arith_cpue
m_modern <- readRDS(here::here("data/generated/cpue-models-pcod-modern.rds"))
```

```{r cpue-save}
readr::write_csv(cpue_pred_modern, here::here("data/generated/cpue-predictions-modern.csv"))
readr::write_csv(cpue_pred_hist, here::here("data/generated/cpue-predictions-historical.csv"))
```

```{r cpue-index-ts-hist}
g1 <- make_cpue_ts_dat(cpue_pred_hist) %>% make_cpue_ts_plot() +
  #ggtitle("1956-1995 CPUE") +
  ylab("")+
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
```

```{r cpue-index-ts-modern}
g2 <- make_cpue_ts_dat(cpue_pred_modern) %>% make_cpue_ts_plot() +
  #ggtitle("1996+ CPUE") +
  ylab("")+
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2")
```

```{r fig-summary-cpue-indices-3cd, fig.cap="Commercial trawl CPUE standardization models for the historical period, 1956--1995 (top) and the modern period, 1996--2022 (bottom). The black line and shaded region indicate a CPUE index with only a year predictor. The coloured line and shaded ribbons shows a standardization model that includes all the predictors plus locality-by-year (space-time) random effects. Locality and locality-year interactions are fit as random effects and all other variables are fit as fixed effects.", echo=FALSE}

P <- cowplot::plot_grid(g1,g2, ncol=1,labels = c("",""), greedy=TRUE)
  # draw__label(en2fr("CPUE (kg/hour)",translate=french), x=  -0.01, y=3, vjust= 1.5, angle=90)+
  # draw_label(en2fr("Year",translate=french), x=  0.5, y=0, vjust= 0, angle=0)
y.grob <- textGrob(en2fr("CPUE (kg/hour)",translate=french), 
                   gp=gpar(fontface="bold", fontsize=15), rot=90)
x.grob <- textGrob(en2fr("Year",translate=french), 
                   gp=gpar(fontface="bold", fontsize=15))
grid.arrange(arrangeGrob(P, left = y.grob, bottom = x.grob))

```


```{r fig-sample-locations, fig.cap="Location of Pacific Cod commercial biological samples by year. The total number of fish sampled in 2017 was 300. The total number sampled in 2019 was 360."}
include_graphics(here("report/figure/commercial_sample_locations_byyear_3CD.png"))
```


```{r}
mw3CD <- read_csv(here::here("data/results/AnnualMeanWeight_3CD.csv"))
```

```{r tri-fig9, fig.cap="Biomass estimates for Pacific Cod in the International North Pacific Fisheries Commission Vancouver region (Canadian waters only) with 95\\% error bars estimated from 1000 bootstraps."}
knitr::include_graphics(here::here("report/paul-figs/fig9.png"))
```



```{r fig-base-index-fits-3cd, fig.cap="Reference model MPD fits to observed indices of abundance (points) for Area 3CD from: (a) the WCVI Synoptic Survey, (b) Commercial CPUE pre-1996, (c) Commercial CPUE post-1995, and (d) the NMFS Triennial Survey (Canadian portion). For clarity, only MPD results are shown."}
plot_grid(i.plot(base.model.3cd, base.model.3cd.name, 1, every = 5, french=french) 
            + scale_y_continuous(labels = comma, limits = c(0, NA)),
          i.plot(base.model.3cd, base.model.3cd.name, 2, every = 5, french=french)  
            + scale_y_continuous(labels = comma, limits = c(0, NA))
            + ylab("Commercial CPUE (kg/h)"),
          i.plot(base.model.3cd, base.model.3cd.name, 3, every = 5, french=french)
            + scale_y_continuous(labels = comma, limits = c(0, NA))
            + ylab("Commercial CPUE (kg/h)"),
          i.plot(base.model.3cd, base.model.3cd.name, 4, every = 5, french=french)
            + scale_y_continuous(labels = comma, limits = c(0, NA)),
          nrow = 2,
          ncol = 2,
          labels = c("(a)", "(b)", "(c)", "(d)"),
          label_x = c(0.15, 0.13, 0.13, 0.2))
```


```{r fig-base-mean-weight-3cd, fig.cap="Reference model MPD fit to the mean weight data for Area 3CD. For clarity, only MPD results are shown."}
plot_grid(mw.plot(base.model.3cd[[1]], cv = 0.2, every = 10, last.yr = 2020, french=french),
          mw.compare.plot(base.model.3cd[[1]], french=french),
          nrow = 1,
          ncol = 2)
```

\clearpage

```{r fig-sens-biomass-3cd-all-avg, fig.cap="Sensitivity of biomass estimates to the the seven sensitivity cases used for model-averaging. Thick solid lines shows the posterior medians and the grey shaded regions represent the 95\\% credible interval. All models use the commercial mean weight index used in Sc. 1 (see Methods)."}
b.plot(c(base.model.3cd, desc.models.3cd), c(base.model.3cd.name, desc.models.3cd.name))
```

```{r fig-sens-recr-3cd-all-avg, fig.cap="Sensitivity of recruitment estimates to the seven sensitivity cases used for model-averaging. Points shows the posterior medians and the bars represent the 95\\% credible interval. All models use the commercial mean weight index used in Sc. 1 (see Methods)."}
r.plot(c(base.model.3cd, desc.models.3cd), c(base.model.3cd.name, desc.models.3cd.name))
```

\clearpage

```{r fig-model-average-biomass-3cd, fig.cap="Combined posterior biomass for the model-averaged set for Area 3CD. Thick solid line shows the posterior median and the grey shaded region represents the 95\\% credible interval. Green dashed line shows the median USR; red dashed line shows the median LRP. Red and green shaded intervals represent the 95\\% credible interval of the LRP and USR, respectively."}
b.plot(avg.model.3cd,
       base.model.3cd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(1986, 1986),
       usr = c(1956, 2004), french=french)
       
```

```{r fig-model-average-f-3cd, fig.cap="Combined posterior fishing mortality for the model-averaged set for Area 3CD. Thick solid line shows the posterior median and the shaded region represents the 95\\% credible interval. Black dashed line shows the median LRR and the horizontal shaded region represents the 95\\% credible interval."}
f.plot(avg.model.3cd,
       base.model.3cd.name,
       add.hist.ref = TRUE,
        lrr = c(1956, 2004), 
       french=french)

```

\clearpage

