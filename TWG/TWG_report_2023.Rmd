---
title: "DRAFT. Status Update of Pacific Cod (*Gadus macrocephalus*) for West Coast Vancouver Island in 2023. Report for the Pacific Cod Technical Working Group."
author: "Robyn Forrest and Sean Anderson"
date: "May 25 2023"
link-citations: true
bibliography: bib/refs.bib
#csl: csl/csas.csl 
documentclass: article
geometry: margin=2.3cm
output:
  bookdown::pdf_document2:
    toc: yes
    fig_caption: yes
    number_sections: yes
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = "knitr-figs/",
  cache.path = if (knitr:::is_latex_output()) "knitr-cache-tex/" else "knitr-cache-docx/",
  fig.asp = 0.618,
  fig.width = 6.5,
  out.width = "5in",
  echo = FALSE,
  autodep = TRUE,
  cache = TRUE,
  cache.comments = FALSE,
  dev = if (knitr:::is_latex_output()) "pdf" else "png",
  dpi = 200,
  fig.align = "center",
  fig.pos = "htb"
)
french <- FALSE
source(file.path(here::here(), "R", "all.R")) #Loading the data is in this file (or pulling it from GFBio if it doesn't exist yet)

```

```{r custom-vars, cache=TRUE, echo=FALSE, message=FALSE, results='hide'}
#NOTE. if adding sensitivity models need to modify load.models.into.parent.env()
# in model-setup.R (as well as path names to sensitivity folders)
build(ovwrt.base = FALSE,
      ovwrt.sens = FALSE,
      ovwrt.retro = FALSE,
      burnin = 1000,
      thin = 1)

load.models.into.parent.env()

source(file.path(rootd.R, "custom-knitr-variables.R")) # Making catch data objects is in this file
```

```{r setup-tables, cache=FALSE, echo=FALSE}
if(!knitr:::is_latex_output())
  options(knitr.table.format = "pandoc")
```

\clearpage

# Context

The 2020 stock assessment for Pacific Cod (*Gadus macrocephalus*) found the Area 3CD (West Coast of Vancouver Island: WCVI) stock to be in the Cautious Zone with > 99% probability [@dfo2021].
This followed a notable reduction in the 2018 WCVI survey index (approximately 26--27% of the 2014 and 2016 observations (Figure \@ref(fig:surv-canadian); Table \@ref(tab:surv-canadian-table))).
Due to the COVID-19 pandemic, the scheduled 2020 WCVI Synoptic Bottom Trawl Survey was postponed to 2021, then returned to its regular biennial schedule in 2022. 
Both the 2021 and 2022 index points were of a similar low magnitude to the 2018 observation (Figure \@ref(fig:surv-canadian)).
Catches from 2018--2020 were also much lower than previous years (Table \@ref(tab:tab-catch-3cd), Figure \@ref(fig:fig-catch-3cd)). 
The commercial CPUE index also decreased substantially in 2018 but has increased slightly since then, with the increases in commercial catch (Figure \@ref(fig:fig-modern-cpue-3cd), Table \@ref(tab:tab-catch-3cd)).
Given the low index point in 2018, the 2020 Science Response recommended updating the assessment when new survey information became available.

The stock assessment is a Bayesian delay-difference model [@deriso1980], fit to commercial and survey indices of abundance, commercial catch and an index of commercial mean weight, which is derived from commercial length samples [see Appendix C of @forrest2020 for methodology].
The commercial mean weight index provides information about recruitment strength to the model.
Due to COVID-19 and a subsequent shift towards at-sea electronic monitoring, there has been no at-sea biological sampling on commercial trawl vessels since 2019. 

A request for science advice for Pacific Cod was issued in 2022 for both the 3CD and 5ABCD (Hecate Strait and Queen Charlotte Sound) stocks. 
The request had two steps: 1) an evaluation to assess the potential sensitivity of the stock assessment to missing length data from the commercial fishery; and 2) update the status of both stocks.
The request advised to only proceed to Step 2 if the missing length data were "deemed to not be of significance to the quality and rigour of the scientific advice".
Using the 2020 assessment model, the authors presented several sensitivity analyses to the Pacific Cod Technical Working Group (TWG) to show the potential effects of the loss of commercial length samples on predicted stock status.
Analyses found that the 2020 Area 3CD model was sensitive to the removal of the last three years of the mean weight index (unpublished report, available on request to the authors).
Following this finding, the TWG met again and evaluated a generalized linear model (GLM) for predicting the commercial mean weight index from a mean weight index derived from WCVI survey samples, assuming the fishery and the survey are sampling the same population. 
The TWG found that the GLM provided a reasonable prediction of the commercial mean weight index for Area 3CD.
The GLM did not have acceptable predictive power for the 5ABCD stock.

Given the ongoing low catches of Area 3CD Pacific Cod and model predictions of very low fishing mortality [@dfo2021], the Pacific Groundfish Management Unit did not request updated catch advice for 2023.
However, given the three low index points in 2018, 2021 and 2022, Science has requested a stock status update to ensure all three of these index points are considered in a timely evaluation of stock status.

<!--This Science Response reports results from the Science Response Process of December 2022 on the Stock Status Update of British Columbia Pacific Cod (*Gadus macrocephalus*) in Area 3CD in 2023. ADD BACK IN TO SR-->
This stock status update uses the same model configurations as the 2020 assessment [@dfo2021], including model-averaged stock status based on the same seven sensitivity scenarios as in 2020.
Recent values of the commercial mean weight index are derived from the GLM presented to the TWG in 2022.
The GLM is used to predict the commercial mean weight index for only the last five years of the assessment.
Prior to 2018, the commercial mean weight index derived from commercial lengths is used.
This enables a continuous mean weight index for the entire model period, beginning in 1956.

# Methods

## Data

Data were extracted from DFO databases using methods described in @forrest2020.
Biological data from fishery-independent and commercial fishery sources were available up until April 2023.

### Commercial catch

Commercial catch data (Table \@ref(tab:tab-catch-3cd) and Figure \@ref(fig:fig-catch-3cd)) were extracted from three different databases held by DFO: *GFCatch* (Canadian trawl landings, 1954--1995); *PacHarvTrawl* (Canadian trawl landings, 1996 to March 31, 2007); and *GFFOS* (Canadian trawl landings, April 1, 2007 to March 31, 2023).
Catch data prior to 1981 include catch by US vessels [@forrest2015; @forrest2020].
Fishing years are defined as beginning on April 1 for all years, and are referenced by starting year, e.g., fishing year 1957 runs from April 1, 1957 to March 31, 1958 [see @forrest2020].

### Canadian bottom trawl surveys

Survey indices (Table \@ref(tab:surv-canadian-table) and Figure \@ref(fig:surv-canadian)) were calculated using a swept area analysis, documented in Appendix A of @forrest2020.
Abundance in Area 3CD is indexed by the WCVI Synoptic Survey.
The survey was first conducted in 2004 and is conducted in alternating (even-numbered) years.
Due to the COVID-19 pandemic the 2020 survey was postponed to 2021,then returned to its regular biennial schedule in 2022.

### NMFS Triennial Survey (in Canadian waters)

An additional relative abundance index for Area 3CD was developed using data from the
National Marine Fisheries Service (NMFS) Triennial survey, which operated off the lower half of WCVI between 1980 and 2001.
See Appendix A of @forrest2020 for details.

### Commercial CPUE

Standardized commercial CPUE indices were developed for the historical (1956--1995) and modern (1996--2022) periods.
The indices were developed using a Tweedie generalized linear mixed model (GLMM) described in detail in Appendix B of @forrest2020.
The historical-period GLMMs included predictors for depth, locality, month, and a locality-year interaction (see @forrest2020).
The modern-period GLMMs included predictors for depth, latitude, locality, month, vessel, and a locality-year interaction (Figure \@ref(fig:fig-modern-cpue-3cd)).

### Annual mean weight in commercial catch

The whole commercial annual mean weight index was calculated using the methodology decribed in Appendix C of @forrest2020.
Commercial biological samples were available for calculating mean weight from 1956 to 2019.
Note that there may be minor differences in the mean weight index compared to that calculated in @forrest2020 due to routine updates and corrections in the databases.

There has been no biological sampling on commercial trawl vessels since 2019.
However, even before the COVID-19 pandemic, there had been a decline in commercial sampling of Pacific cod since 2015 (Appendix A). 
In Area 3CD, only four samples were taken in 2017 (total 300 fish), no samples were taken in 2018, and only two samples were taken in 2019 (total 360 fish). 
The 2017 mean weight value was anomalously high (3.024 kg) and, given that it was only based on two samples, it was not used in the 2020 stock assessment update [@dfo2021]. 
Due to lack of samples, the 2020 assessment used the 2019 mean weight value for both 2019 and 2020 [@dfo2021], although we note that this was not ideal as the 2019 index point was also based on only two samples.

Therefore a methodology was developed for predicting the commercial mean weight index from a mean weight index derived from length samples in the WCVI Synoptic Survey (Appendices B and C).
The methodology was presented to the TWG in 2022 and provided a reasonable fit to the observed commercial mean weight data.

## Modelling steps

In order to investigate the sensitivity of the model to different treatments of the commercial mean weight index, the following steps were taken:

Step 1. Develop a survey mean weight index (see Appendix B for methods and results);

Step 2. Use a generalized linear regression model (GLM) with a log link to predict commercial mean weight from survey mean weight (see Appendix C for methods and results);

Step 3. Update model data files with predicted commercial mean weight index values for 2018-2022, noting that predicted commercial mean weight index values are only available for years in which there was a survey.
Therefore, evaluate four alternative scenarios that differ only in treatment of the last five years of the commercial mean weight index (see next section).

Step 4. Run the models and evaluate sensitivity of model results to the updated commercial mean weight indices.

Step 5. Select the best mean weight index scenario (based on model diagnostics and TWG consensus) to use in the seven sensitivity cases for model-averaging and update the data files accordingly.

Step 6. Run the seven sensitivity models for model averaging and report stock status.

## Model scenarios: sensitivity to treatment of the commercial mean weight index

All scenarios used the commercial mean weight index for the years 1956--2016, with no 2017 index point, as in the 2020 assessment.
The GLM (Appendix B) predicted values for the commercial mean weight index only for years when there was a survey (i.e., predicted values were generated for survey years 2018, 2021 and 2022; Figure \@ref(fig:all-mean-weight-series-3cd)).

Therefore four sensitivity cases were explored, which differed in terms of the treatment of the commercial mean weight index for the years 2018--2022. Values of the index used in the different scenarios since 2010 are shown in Table \@ref(fig:tab-mean-weight-recent-3cd).

Sc. 1 Interpolation: For 2018--2022, use the GLM predicted values for 2018, 2021 and 2022. Use linear interpolation between 2018 and 2021 to fill in values for 2019 and 2020.

Sc. 2 No interpolation: For 2018--2022, use the GLM predicted values for 2018, 2021 and 2022. Do not include values for 2019 and 2020.

Sc. 3 No GLM, with extrap: For the last seven years of the time series, use the same approach as in the 2021 assessment [@dfo2021], i.e, commercial mean weight index values for 2016, 2019 and 2020, where the 2020 value was set the same as the 2019 value. Continue to use the 2019 value for 2021 and 2022.

Sc 4. No GLM, no extrap: Same as Sc. 3 but do not include any values for 2021 and 2022.

For all model runs, the joint posterior distribution was numerically approximated using the Markov Chain Monte Carlo (MCMC) routines built into AD Model Builder (Metropolis-Hastings algorithm) [@fournier2012]. 
Posterior samples were drawn every 2,500 iterations from a chain of length 5 million, resulting in 2,000 posterior samples (the first 1,000 samples were dropped to allow for sufficient burn-in).

## Model-averaged stock status

The previous two stock assessments for 3CD Pacific Cod used a model-averaging approach to develop estimates of stock status and decision tables [@dfo2019; @dfo2021].
A set of seven model scenarios for for model averaging was agreed upon at the Canadian Science Advisory Secretariat (CSAS) Regional Peer Review (RPR) meeting for the 2018 assessment [@dfo2019].
The same set of model scenarios (with updated data) were used in the 2020 update [@dfo2021].
Full details on the model configurations and assumptions for each scenario are provided in @forrest2020.

To proceed with estimating stock status using the model-averaging approach, it is necessary to select a scenario for treatment of the commercial mean weight index, to use in all seven models.
This decision will ultimately be made with guidance of the TWG.
In the meantime, noting the similarity of all four mean weight index scenarios (see Results), the seven sensitivity models were set up with the same commercial mean weight index that was used in Sc. 1 (Interpolation) above.

As above, posterior samples were drawn every 2,500 iterations from a chain of length 5 million, resulting in 2,000 posterior samples (the first 1,000 samples were dropped to allow for sufficient burn-in).

# Results

## Model scenarios: sensitivity to treatment of the commercial mean weight index 

Maximum posterior density (MPD) model fits to the commercial mean weight index from the Reference Case model and Scenarios 1 and 2 are shown in Figures \@ref(fig:fig-base-mean-weight-3cd) to \@ref(fig:fig-base-mean-weight-3cd-sc2). As in previous assessments [@forrest2020], model fits to the mean weight index in all scenarios were generally poor, with the models tending to underestimate observed mean weight, especially in the earlier part of the time series. 

Posterior biomass estimates from the Reference Case model are shown in Figure \@ref(fig:fig-model-ref-biomass-3cd). Compared to this model, Scenarios 1 and 2 resulted in reduced estimates of biomass for 2019-2020 and a reduced 2021 forecast (Table \@ref(tab:tab-est-biomass-3cd); Figure \@ref(fig:fig-sens-biomass-3cd)). The percentage change for the median 2021 forecast biomass ranged from -24.5% in Scenario 1 to -15.8% in Scenario 2 (Table \@ref(tab:tab-est-biomass-3cd-per)). Median posterior estimates of recruitment were much lower in 2019-2020 in Scenarios 1 and 2 compared to the Reference Case, with the percentage change ranging from -53.9% in Scenario 1 to -27.8% in Scenario 2 (Table \@ref(tab:tab-est-recruit-3cd); Figure \@ref(fig:fig-sens-recr-3cd)). We note that biases were larger in Scenario 1, where interpolation was applied, than in Scenario 2, where it was not.

The lower estimates of 2019-2020 recruitment in Scenarios 1 and 2, compared to the Reference Case model, especially in Scenario 1, are mostly likely driven by the higher mean weights in 2018-2020 (Table \@ref(tab:tab-mean-weight-recent-3cd)), which would imply fewer small fish in the catch, all other things equal. 

Clearly from Tables \@ref(tab:tab-est-biomass-3cd-per) and \@ref(tab:tab-est-recruit-3cd), recruitment estimates are more strongly influenced by the mean weight index than biomass estimates, which are more directly influenced by catch and indices of abundance. However, given the short lifespan of Pacific cod in BC (~10-11 years) and the assumed early age of maturity in the models (2 years), changes in estimates of recruitment are expected to impact estimates of biomass relatively quickly. 

## Model-averaged stock status



# Conclusions

We were able to derive a catch-weighted survey mean weight index for each area. We were able to derive a predicted commercial mean weight index from the survey mean weight index. The survey mean weight index was a better predictor of the commercial mean weight index in Area 3CD, compared to Area 5ABCD.

The effects of the two alternative treatments in each area were stronger for Area 3CD than for Area 5ABCD, especially for recruitment. This was because the last observed 2019 mean weight index value used in the Reference Case model was much lower (~0.5-1.0 kg lower) than the values used for 2018-2020 in Scenarios 1 and 2. The larger perceived bias in Area 3CD should be considered in light of the fact that the 2019 and 2020 commercial mean weight values used in the 2020 Reference Case model were based on only two samples. Given the apparent strong relationship between the survey and fishery prior to 2016 (Figure \@ref(fig:fig-comm-vs-survey-weights-3cd)), the predicted commercial mean weight index may represent more realistic values.

The results of this exercise highlight obvious differences in selectivity between the commercial fishery and synoptic surveys, especially in Area 5ABCD, where the survey catches much smaller fish. This represents a violation of the assumptions of the delay-difference model, which assumes knife-edged selectivity in both the survey and fishery. However, violation of this assumption is probably less consequential than the assumption of the same knife-edged maturity. As long as the relative selectivities in the survey and fishery remain approximately constant, calibration exercises such as this may be an acceptable approach to continue the time series of the commercial mean weight index, although this should be evaluated through simulation-testing. 

\clearpage

# References {-}

<!-- This allows appendices to appear after the references -->
<div id="refs"></div>

\clearpage

# Tables

```{r surv-canadian-table, results='asis'}
dplyr::filter(dat$survey_index, survey_abbrev %in%
  c("SYN WCVI")) %>%
  dplyr::select(survey_abbrev, year, biomass, re, lowerci, upperci, num_sets, num_pos_sets) %>%
  dplyr::mutate(lowerci = round(lowerci/1000, 1), upperci = round(upperci/1000, 1),
    biomass = round(biomass/1000, 1), re = round(re, 2)) %>%
  dplyr::rename(`Survey abbrev.` = survey_abbrev, Year = year, Biomass = biomass,
    CV = re, `Lower CI` = lowerci, `Upper CI` = upperci, Sets = num_sets, `Positive sets` = num_pos_sets) %>%
  dplyr::arrange(`Survey abbrev.`, Year) %>%
  knitr::kable(caption = "Pacific Cod survey data for the WCVI synoptic trawl survey (SYN WCVI) in metric tons (without accounting for survey catchability). Positive sets refers to the number of trawl sets that caught Pacific Cod.", booktabs = TRUE, linesep = "", 
    format = "pandoc")
```

\clearpage


```{r tab-catch-3cd}
catch.table(catch.3,
            catch.3.discards,
            pre.1996.discards.3cd,
            area = "3CD",
 cap = paste0("Reported catch (mt) of Pacific Cod in Area 3CD ",
              "by Canada and the USA, ",
              min(catch.3$year)+3, "--", max(catch.3$year),
              ". The reported releases at sea (discards) for the period ", min(catch.3$year)+3,
              "--1995 are ",
              "likely unrepresentative of true discarding because the estimates were taken ",
              "from logbooks in the absence of observers. Discard estimates since 1996 are based on at-sea ",
              "observations and are considered to be more representative of true discarding. Numbers are rounded for presentation."), french=french)
```

\clearpage


```{r tab-mean-weight-recent-3cd, results='asis'}
mw.table(c(base.model.3cd, 
           sens.models.11), 
         c(base.model.3cd.name, 
           sens.models.name.11), 
         years=2010:2022,
         area="3CD",
         caption="Comparison of mean weight values used in the 2020 Reference Case model and sensitivity analyses. See Methods for scenario descriptions.")

```

\clearpage

```{r tab-est-biomass-3cd, results='asis'}
make.value.table.compare(c(base.model.3cd, 
                           sens.models.11), 
                 c(base.model.3cd.name, 
                   sens.models.name.11), 
                 years=2010:2022,
                 type= 1,
                 mpdmed="med",
                 caption = "Comparison of recent median posterior biomass estimates from the 2022 Reference Case model and sensitivity analyses. See Methods for scenario descriptions.")

```

```{r tab-est-biomass-3cd-per, results='asis'}
make.value.table.compare(c(base.model.3cd, 
                           sens.models.11), 
                 c(base.model.3cd.name, 
                   sens.models.name.11), 
                 years=2010:2022,
                 type= 1,
                 mpdmed="med",
                 caption = "Comparison of percentage difference in median posterior biomass estimates from the 2022 Reference Case model and sensitivity analyses. See Methods for scenario descriptions.",
                 percent=TRUE)

```


\clearpage


```{r tab-est-recruit-3cd, results='asis'}

make.value.table.compare(c(base.model.3cd), 
                 c(base.model.3cd.name), 
                 years=2010:2022,
                 type= 2,
                 mpdmed="med",
                 caption = "Comparison of recent median posterior recruitment estimates from the 2022 Reference Case model and sensitivity analyses. See Methods for scenario descriptions.")

```

```{r tab-est-recruit-3cd-per, results='asis'}
make.value.table.compare(c(base.model.3cd, 
                           sens.models.11), 
                 c(base.model.3cd.name, 
                   sens.models.name.11),
                 years=2010:2020,
                 type= 2,
                 mpdmed="med",
                 caption = "Comparison of percentage difference in median posterior recruitment estimates from the 2022 Reference Case model and sensitivity analyses. See Methods for scenario descriptions.",
                 percent=TRUE)

```

\clearpage

```{r summary-tab-stock-status-avg-3cd, results='asis'}
stock.status(avg.model.3cd,
                caption = paste0("Current stock status with model averaging. Models averaged are: ",
                                 and.string(c(base.model.3cd.name, sens.models.name.13.sub)),
                                 "."), french=french) #
```

```{r summary-tab-projection-zero-avg-3cd, results='asis'}
decision.table.zero.tac(avg.model.3cd,
               caption = paste0("Probabilities of stock breaching reference points under TAC = 0 for a one-year projection, with model averaging. Models averaged are: ",
                                and.string(c(base.model.3cd.name, sens.models.name.13.sub)),
                                "."), 
               french=french) #
```

```{r summary-tab-decision-avg-3cd, results='asis'}
 decision.table(avg.model.3cd,
                caption = paste0("Decision table with model averaging. Models averaged are: ",
                                 and.string(c(base.model.3cd.name, sens.models.name.13.sub)),
                                 "."), french=french) #
```

\clearpage

# Figures

```{r surv-canadian, fig.cap="Pacific Cod survey data for the West Coast Vancouver Island synoptic bottom trawl survey (SYN WCVI), showing relative biomass and associated lower and upper confidence intervals. Positive sets refers to the number of trawl sets that caught Pacific Cod."}
gfplot::tidy_survey_index(dat$survey_index,
  survey = "SYN WCVI") %>%
  plot_survey_index(french=french)
```

```{r fig-catch-3cd, fig.cap="Catch for Area 3CD. Canadian catch includes at-sea releases."}
make.catches.plot(catch.3, french=french) +
  scale_y_continuous(labels = comma,
                       limits = c(0, NA))
```

```{r fig-modern-cpue-3cd, fig.cap="Pacific Cod commercial CPUE. Red series shows the fully standardized model described in Forrest et al. (2020). The aritmetic mean is shown with the dashed line."}
knitr::include_graphics(file.path(generatedd,paste0("CPUE_Modern_Fully_Standardized_3CD.png")))

```


\clearpage


```{r fig-base-mean-weight-3cd, fig.cap="Scenario 1 model MPD fit to the mean weight data. See Methods for scenario descriptions."}
plot_grid(mw.plot(base.model.3cd[[1]], cv = 0.2, every = 10, last.yr = 2022, french=french),
          mw.compare.plot(base.model.3cd[[1]], french=french),
          nrow = 1,
          ncol = 2)
```

```{r fig-base-mean-weight-3cd-sc2, fig.cap="Scenario 2 model MPD fit to the mean weight data. See Methods for scenario descriptions."}
plot_grid(mw.plot(sens.models.11[[1]], cv = 0.2, every = 10, last.yr = 2022, french=french),
          mw.compare.plot(sens.models.11[[1]], french=french),
          nrow = 1,
          ncol = 2)
```


```{r fig-base-mean-weight-3cd-sc3, fig.cap="Scenario 3 model MPD fit to the mean weight data. See Methods for scenario descriptions."}
plot_grid(mw.plot(sens.models.11[[2]], cv = 0.2, every = 10, last.yr = 2022, french=french),
          mw.compare.plot(sens.models.11[[2]], french=french),
          nrow = 1,
          ncol = 2)
```


```{r fig-base-mean-weight-3cd-sc4, fig.cap="Scenario 4 model MPD fit to the mean weight data. See Methods for scenario descriptions."}
plot_grid(mw.plot(sens.models.11[[3]], cv = 0.2, every = 10, last.yr = 2022, french=french),
          mw.compare.plot(sens.models.11[[3]], french=french),
          nrow = 1,
          ncol = 2)
```


\clearpage


```{r fig-sens-biomass-3cd, fig.cap="Sensitivity of biomass estimates to model scenarios. See Methods for scenario descriptions."}
b.plot(c(base.model.3cd, sens.models.11), c(base.model.3cd.name, sens.models.name.11))
```

```{r fig-sens-recr-3cd, fig.cap="Sensitivity of recruitment estimates to model scenarios. See Methods for scenario descriptions."}
r.plot(c(base.model.3cd, sens.models.11), c(base.model.3cd.name, sens.models.name.11))
```

\clearpage

```{r fig-sens-biomass-3cd-all-avg, fig.cap="Sensitivity of biomass estimates to the the seven sensitivity cases used for model-averaging. All models use the commercial mean weight index used in Sc. 1 (see Methods)."}
b.plot(c(base.model.3cd, desc.models.3cd), c(base.model.3cd.name, desc.models.3cd.name))
```

```{r fig-sens-recr-3cd-all-avg, fig.cap="Sensitivity of recruitment estimates to the seven sensitivity cases used for model-averaging. All models use the commercial mean weight index used in Sc. 1 (see Methods)."}
r.plot(c(base.model.3cd, desc.models.3cd), c(base.model.3cd.name, desc.models.3cd.name))
```

\clearpage

```{r fig-model-average-biomass-3cd, fig.cap="Combined posterior biomass for the model-averaged set. Thick solid line shows the posterior median and the grey shaded region represents the 95\\% credible interval. Green dashed line shows the median USR; red dashed line shows the median LRP. Red and green shaded intervals represent the 95\\% credible interval of the LRP and USR, respectively."}
b.plot(avg.model.3cd,
       base.model.3cd.name,
       depl = FALSE,
       add.hist.ref = TRUE,
       lrp = c(1986, 1986),
       usr = c(1956, 2004), french=french)
       
```

```{r fig-model-average-f-3cd, fig.cap="Combined posterior fishing mortality for the model-averaged set. Thick solid line shows the posterior median and the shaded region represents the 95\\% credible interval. Black dashed line shows the median LRR and the horizontal shaded region represents the 95\\% credible interval."}
f.plot(avg.model.3cd,
       base.model.3cd.name,
       add.hist.ref = TRUE,
       lrr = c(1956, 2004), 
       french=french)

```

\clearpage

# (APPENDIX) Appendix {-} 

# Changes in commercial length sampling {#sec:AppendixA}

```{r get-length-samples-3cd}

comm_samp <- dat$commercial_samples %>% 
  dplyr::filter(major_stat_area_name %in% c("3C: S.W. VANCOUVER ISLAND","3D: N.W. VANCOUVER ISLAND"), 
                year>1995) 

summary_by_year <- comm_samp %>% 
  select(year,sample_id,length) %>% 
  group_by(year) %>%
  summarize(nsamples=n_distinct(sample_id),
            nlengths=sum(!is.na(length)),
            meanlength=round(mean(length),2),
            sdlength=round(sd(length),2),
            selength=round(sdlength/sqrt(nlengths),2))

 colnames(summary_by_year) <- c("Year", "Num samples", "Num lengths","Raw mean length", "SD length", "SE length")

knitr::kable(summary_by_year,
               caption = "Summary of commercial length samples since 1996 for Area 3CD. Mean lengths are unweighted by catch and are presented to visualise changes in sampling effort since 2015.",
               longtable = TRUE, format = "pandoc",
               align = get.align(ncol(summary_by_year))[-1],
               booktabs = TRUE, linesep = "", escape = FALSE, row.names = FALSE) %>%
    kableExtra::kable_styling(latex_options = c("hold_position", "repeat_header"))

```

```{r plot-length-samples-3cd, fig.cap="Summary of raw commercial length samples since 2000 for Area 3CD. Mean lengths are unweighted by catch."}

g <- summary_by_year %>% 
  dplyr::filter(Year>1999) %>% 
  ggplot(aes(x=Year, y=`Raw mean length`))+
  geom_point(size=3)+
  geom_errorbar(aes(ymin=`Raw mean length`-`SE length`, ymax=`Raw mean length`+ `SE length`),  width=0.1)+
  labs(x = "Year", y = "Raw mean length (cm)")+
  gfplot::theme_pbs()+
  scale_color_viridis_d() +
  theme(plot.title = element_text(face="bold", size=14),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.text.x = element_text(size=10))

g

```

\clearpage

# Developing a survey mean weight index {#sec:AppendixB}

## Methods

We followed the steps in Appendix C of @forrest2020, which described the methodology for weighting the commercial length samples to produce a commercial mean weight index, weighted by sequential quarter and catch weight. 
We also adapted the approach for the West Coast Vancouver Island Synoptic Survey by replacing weighting by sequential quarter, which was done for the commercial samples, with weighting by depth stratum (Equations 3 and 4).
This was done because the survey is depth-stratified.

Note that for the survey mean weight index, we derived weights of individual fish from the measured lengths, using published length-weight parameters rather than using weights that were directly measured (Equation 1).
This was because far more fish were measured than were weighed.
This also follows the approach used for the commercial mean weight index.

The calculation of the survey annual mean weight index was done in the following steps. For simplicity, we have dropped year subscripts.

1. For each specimen $i$, in each Sample ID $j$, in each depth stratum $s$, convert individual length ($L_{i,j,s}$)  to weight ($W_{i,j,s}$):

\begin{equation}
{W_{i,j,s}} = \alpha{L_{i,j,s}}^{\beta}
\end{equation}

where $\alpha$ and $\beta$ are constant length-weight parameters, where the values of the length-weight parameters are `r paste0("$\\alpha = ", .ALPHA3, "$")` and `r paste0("$\\beta = ", .BETA3, "$")`.

2. Calculate the mean weight ($W_j$) in each sample ID $j$, in each depth stratum $s$:

\begin{equation}
  {W_{j,s}} =  \frac{\sum\limits_{i=1}^{N_{j,s}}{{w_{i,j,s}}}}{{N_{j,s}}}
\end{equation}

where $N_{j,s}$ is the number of weights $W_{i,j,s}$ in sample ID $j$ and depth stratum $s$.

3. Calculate the mean weight ($W_s$) for each depth stratum $s$, weighted by the sample weights $S$:

\begin{equation}
{W_s} = \frac{{\sum\limits_{j=1}^{{N_s}} {{W_{j,s}S_{j,s}}}}}{{\sum\limits_{j=1}^{{N_s}} {{S_{j,s}}}}}
\end{equation}

where $N_s$ is the number of samples in depth stratum $s$.

4. Calculate the annual survey mean weight ($W$), weighted by the catch $C_s$ in each stratum $s$:

\begin{equation}
{W} = \frac{{\sum\limits_{s=1}^{{K}} {{W_sC_s}}}}{{\sum\limits_{s=1}^{{K}} {{C_s}}}}
\end{equation}

where $K$ is the number of depth strata surveyed in that year.

\clearpage

## Results

The commercial mean weight index, calculated using the method shown in Appendix C of @forrest2020 is shown in Figure \@ref(fig:fig-comm-mean-weights-3cd), which indicates number of sampling events for each index year, as well as the two index values that were removed due to low sampling effort (2017 and 2019, Appendix A).

Figure \@ref(fig:fig-meas-vs-calc-weights-3cd) shows the relationship between observed weights obtained by directly weighing individual fish vs weights calculated using Equation 1.
Figure \@ref(fig:fig-comm-vs-survey-weights-3cd) shows the commercial mean weight index obtained from the methods described in @forrest2020, compared with the survey mean weight index obtained from Equations 1--4.
Figure \@ref(fig:fig-comm-vs-survey-weights-3cd-2) shows the commercial mean weight index plotted against with the survey mean weight index, with a linear regression line.
The number of sampling events is indicated by the sizes of the circles in Figures \@ref(fig:fig-comm-vs-survey-weights-3cd) and \@ref(fig:fig-comm-vs-survey-weights-3cd-2).


```{r fig-comm-mean-weights-3cd, fig.cap="Time series of commercial mean weight series, calculated using methods shown in Forrest et al. 2020. Size of the circles indicates the number of sampling events. Black crosses indicate the 2017 and 2019 index values, which were removed from further analysis due to low sample sizes (see Appendix A). ", out.width="4in"}
knitr::include_graphics(here::here("data/generated/commercial_mean_weight_3CD.png"))
```

```{r fig-meas-vs-calc-weights-3cd, fig.cap="Observed vs calculated weights from the WCVI survey, all years all depth strata", out.width="4in"}
knitr::include_graphics(here::here("data/generated/Measured_v_Calc_weights_survey3CD.png"))
```

```{r fig-comm-vs-survey-weights-3cd, fig.cap="Commercial mean weight index and survey mean weight index. Size of the circles indicates the number of sampling events. To aid visualization, the commercial mean weight index is truncated to begin in 2000.", out.width="4in"}
knitr::include_graphics(here::here("data/generated/Comm_v_Survey_weights_3CD.png"))
```

```{r fig-comm-vs-survey-weights-3cd-2, fig.cap="Log commercial mean weight index vs log survey mean weight index. The blue line shows linear fit. Size of the circles indicates the number of sampling events.", out.width="4in"}
knitr::include_graphics(here::here("data/generated/lnSurvey_v_lnCom_with_lm_fit_3CD.png"))
```

\clearpage


# Generalized Linear Model to predict commercial mean length index {#sec:AppendixC}

## Methods

We used a simple GLM with a Gamma log link function, to estimate model fit of commercial mean weights ($y_t$) in year $t$ to the log survey mean weights ($W_t$), calculated in Appendix B:

\begin{align}
{y_t} \sim \mathrm{Gamma}(\phi / \mu_t, \phi), \\
\log(\mu_t) = \beta_0 + \beta_1 \log(W_t) 
\end{align}

where the $\phi$ parameter contributes to both the rate and shape of the Gamma distribution.

Using the `predict` function in R, we then used the model to predict commercial mean weights from available survey mean weights. 


## Results

**TODO: Best way to describe the GLM results? Does the t statistic mean anything useful?**

In log space, the GLM linear fit estimated an intercept of 0.341 (s.e. 0.109), or 1.41 kg in natural space, with slope = 0.751 (s.e. 0.231).

Figure \@ref(fig:all-mean-weight-series-3cd) shows time series of all three series, the survey mean weight index, observed commercial mean weight index , and predicted mean weight index from the GLM, indicating good agreement between the commercial and survey mean weight indices.


```{r all-mean-weight-series-3cd, fig.cap="Survey mean weight index (blue), observed commercial mean weight index (red), and predicted mean weight index (green) from the GLM. For visualization purposes, the observed commercial mean weight index is truncated to begin in 2004, the year of the first survey.", out.width="4in"}
knitr::include_graphics(here::here("data/generated/Compare_Obs_v_Predicted_Weight3CD.png"))
```


\clearpage

# Model diagnostics {#sec:AppendixD}
